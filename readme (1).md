# Установщик PostgreSQL на удаленный сервер

Данное консольное приложение предназначено для автоматизированной установки и настройки PostgreSQL на один из двух удаленных серверов. Приложение самостоятельно определяет наименее загруженный сервер из двух предложенных, устанавливает PostgreSQL, настраивает его для приема внешних соединений и создает пользователя `student` с ограничением доступа только с IP-адреса второго сервера.

## Функциональность

- Подключение к удаленным хостам по SSH с использованием ключа
- Оценка загруженности серверов и выбор наименее нагруженного
- Автоматическое определение типа операционной системы (Debian или CentOS/AlmaLinux)
- Установка PostgreSQL с использованием соответствующего пакетного менеджера
- Настройка PostgreSQL для приема внешних соединений
- Создание пользователя `student` с ограниченным доступом
- Тестирование работоспособности установленной базы данных

## Требования

- Python 3.6+
- Доступ к двум удаленным серверам с правами root
- SSH-ключ для аутентификации на серверах
- Установленная библиотека `paramiko` (автоматически устанавливается при использовании requirements.txt)

## Установка

1. Клонируйте репозиторий:
```bash
git clone https://github.com/yourusername/remote-postgres-installer.git
cd remote-postgres-installer
```

2. Создайте виртуальное окружение (рекомендуется):
```bash
python -m venv venv
source venv/bin/activate  # для Linux/Mac
# или
venv\Scripts\activate  # для Windows
```

3. Установите необходимые зависимости:
```bash
pip install -r requirements.txt
```

## Использование

Запустите скрипт, указав IP-адреса или имена серверов через запятую:

```bash
python remote_postgres_installer.py 192.168.1.10,192.168.1.11
```

Если ваш SSH-ключ расположен не в стандартном месте (~/.ssh/id_rsa), укажите путь к нему с помощью параметра `--key`:

```bash
python remote_postgres_installer.py 192.168.1.10,192.168.1.11 --key /path/to/your/ssh/key
```

## Примеры использования

1. Установка PostgreSQL на один из двух серверов с использованием стандартного пути к SSH-ключу:
```bash
python remote_postgres_installer.py server1.example.com,server2.example.com
```

2. Установка с указанием пути к SSH-ключу:
```bash
python remote_postgres_installer.py 10.0.0.1,10.0.0.2 --key ~/.ssh/custom_key
```

## Принятые решения и особенности реализации

При разработке приложения были приняты следующие решения:

1. **Выбор языка**: Был выбран Python из-за простоты использования библиотеки `paramiko` для SSH-подключений и гибкости в обработке различных сценариев установки.

2. **Определение ОС**: Для определения типа операционной системы используется сочетание методов: проверка файла `/etc/os-release` и проверка наличия пакетных менеджеров `apt-get` и `yum`.

3. **Пароль пользователя**: Для пользователя `student` устанавливается пароль `StrongPassword123!`. В реальном производственном сценарии рекомендуется использовать более безопасный способ генерации и хранения паролей.

4. **Версия PostgreSQL**: На серверах CentOS/AlmaLinux устанавливается PostgreSQL 14 из официального репозитория, так как это стабильная версия с долгосрочной поддержкой. На Debian используется версия из стандартных репозиториев.

5. **Определение загрузки системы**: Для определения загрузки используется показатель средней загрузки системы за 1 минуту из файла `/proc/loadavg`.

6. **Обработка ошибок**: Приложение включает обработку различных ошибок, которые могут возникнуть при установке и настройке, и выводит понятные диагностические сообщения.

7. **Проверка соединения**: Для проверки работоспособности установленной базы данных выполняется простой SQL-запрос `SELECT 1`.

## Вопросы, возникшие при разработке, и принятые решения

1. **Вопрос**: Какие версии PostgreSQL следует устанавливать на разные ОС?  
   **Решение**: На CentOS/AlmaLinux используется PostgreSQL 14 из официального репозитория, так как это стабильная и рекомендуемая версия. На Debian устанавливается версия из стандартных репозиториев дистрибутива.

2. **Вопрос**: Как надежно определить тип ОС?  
   **Решение**: Используется комбинированный подход: проверка содержимого `/etc/os-release` и проверка наличия пакетных менеджеров. Это обеспечивает надежное определение типа ОС даже в случае нестандартных конфигураций.

3. **Вопрос**: Как обеспечить безопасность при открытии доступа к PostgreSQL?  
   **Решение**: Доступ пользователя `student` ограничен только с IP-адреса второго сервера, а для остальных соединений требуется аутентификация по паролю.

4. **Вопрос**: Как определить наименее загруженный сервер?  
   **Решение**: Используется значение загрузки системы за 1 минуту из `/proc/loadavg`, что дает хорошее представление о текущей нагрузке.

5. **Вопрос**: Как обрабатывать ситуацию, когда установка не удалась?  
   **Решение**: Приложение проверяет результат каждого шага установки и настройки, при ошибке выводит подробное диагностическое сообщение и возвращает ненулевой код завершения.

## Лицензия

MIT
